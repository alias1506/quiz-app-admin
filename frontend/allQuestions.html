<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Portal - Bootstrap 5 Admin Dashboard Template For Developers</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Portal - Bootstrap 5 Admin Dashboard Template For Developers"
    />
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media" />
    <link rel="shortcut icon" href="favicon.ico" />

    <!-- FontAwesome JS -->
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
      .fixed-height-textarea {
        height: 100px !important;
        resize: none;
      }
      .fixed-select {
        min-width: 150px;
      }

      /* Loading state for select */
      .select-loading {
        opacity: 0.6;
        pointer-events: none;
      }
      /* Blur effect for background modal */
      .modal-blur {
        filter: blur(3px);
        transition: filter 0.3s ease;
      }
      /* Delete button styling */
      .delete-set {
        color: #dc3545;
        cursor: pointer;
      }
      .delete-set:hover {
        color: #c82333;
      }
      .fixed-pagination-above-footer {
        position: fixed;
        bottom: 50px; /* Adjust to match your footer height */
        left: 0;
        right: 0;
        z-index: 1020;
        background: white;
        border-top: 1px solid #dee2e6;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .pagination-spacer-above-footer {
        height: 120px; /* Footer height + Pagination height */
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .fixed-pagination-above-footer .d-flex {
          flex-direction: column;
          gap: 10px;
        }

        .fixed-pagination-above-footer
          .d-flex.justify-content-between
          > div:last-child {
          align-items: center !important; /* Center align on mobile */
        }

        .pagination-spacer-above-footer {
          height: 140px;
        }
      }

      /* Active set indicator */
      .active-set-badge {
        background: linear-gradient(45deg, #28a745, #20c997);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
      }
    </style>
    <script defer src="assets/js/sessionManager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        // Your code to show the modal goes here
        (function () {
          // Check session using SessionManager
          const sessionCheck = sessionManager.checkSession();

          if (!sessionCheck.valid) {
            console.log("Session invalid:", sessionCheck.reason);
            sessionManager.redirectToLogin();
            return;
          }

          // Optional: Log session info for debugging
          const userInfo = sessionManager.getUserInfo();
          if (userInfo) {
            console.log("User authenticated:", userInfo.userId);
            console.log("Session ID:", userInfo.sessionId);
          }
        })();
      });
    </script>
  </head>

  <body class="app">
    <header class="app-header fixed-top">
      <div class="app-header-inner">
        <div class="container-fluid py-2">
          <div class="app-header-content">
            <div class="row justify-content-between align-items-center">
              <div class="col-auto">
                <a
                  id="sidepanel-toggler"
                  class="sidepanel-toggler d-inline-block d-xl-none"
                  href="#"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="30"
                    height="30"
                    role="img"
                  >
                    <title>Menu</title>
                    <path
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-miterlimit="10"
                      stroke-width="2"
                      d="M4 7h22M4 15h22M4 23h22"
                    ></path>
                  </svg>
                </a>
              </div>
              <div class="search-mobile-trigger d-sm-none col">
                <i
                  class="search-mobile-trigger-icon fa-solid fa-magnifying-glass"
                ></i>
              </div>
              <div class="app-search-box col">
                <form class="app-search-form">
                  <input
                    type="text"
                    placeholder="Search..."
                    name="search"
                    class="form-control search-input"
                  />
                  <button type="submit" class="btn search-btn btn-primary">
                    <i class="fa-solid fa-magnifying-glass"></i>
                  </button>
                </form>
              </div>
              <div class="app-utilities col-auto">
                <div class="app-utility-item app-user-dropdown dropdown">
                  <a
                    class="dropdown-toggle"
                    id="user-dropdown-toggle"
                    data-bs-toggle="dropdown"
                    href="#"
                    role="button"
                  >
                    <img src="assets/images/user.png" alt="user profile" />
                  </a>
                  <ul
                    class="dropdown-menu"
                    aria-labelledby="user-dropdown-toggle"
                  >
                    <li>
                      <a
                        class="dropdown-item"
                        href="javascript:void(0);"
                        id="logout"
                        >Log Out</a
                      >
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="app-sidepanel" class="app-sidepanel">
        <div id="sidepanel-drop" class="sidepanel-drop"></div>
        <div class="sidepanel-inner d-flex flex-column">
          <a href="#" id="sidepanel-close" class="sidepanel-close d-xl-none"
            >&times;</a
          >
          <div class="app-branding">
            <a class="app-logo" href="index.html">
              <img
                class="logo-icon me-2"
                src="assets/images/app-logo.svg"
                alt="logo"
              />
              <span class="logo-text">PORTAL</span>
            </a>
          </div>
          <nav id="app-nav-main" class="app-nav app-nav-main flex-grow-1">
            <ul class="app-menu list-unstyled accordion" id="menu-accordion">
              <li class="nav-item">
                <a class="nav-link" href="dashboard.html">
                  <span class="nav-link-text">Dashboard</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="allQuestions.html">
                  <span class="nav-link-text">Add Questions</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <div class="app-wrapper">
      <div class="px-5 py-3">
        <h1>Add Questions</h1>
        <div class="d-flex justify-content-between align-items-center">
          <!-- Left side: Active Set selector -->
          <div class="d-flex align-items-center gap-3">
            <!-- Active Set selector -->
            <div class="d-flex align-items-center">
              <label for="activeSet" class="form-label mb-0 me-2 text-nowrap"
                >Active Set:</label
              >
              <select
                id="activeSet"
                class="form-select form-select-sm fixed-select"
              >
                <option value="">Select Set</option>
              </select>
            </div>

            <!-- Show Questions selector -->
            <div class="d-flex align-items-center">
              <label
                for="showQuestions"
                class="form-label mb-0 me-2 text-nowrap"
                >Show Questions:</label
              >
              <select
                id="showQuestions"
                class="form-select form-select-sm fixed-select"
              >
                <option value="" selected>All</option>
                <option value="active">Active Set Only</option>
              </select>
            </div>
          </div>

          <!-- Right side: All 3 buttons -->
          <div class="d-flex align-items-center gap-2">
            <button
              id="addSetBtn"
              class="btn btn-sm btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#AddSetModal"
            >
              + Add Set
            </button>
            <button
              id="showSetsBtn"
              class="btn btn-sm btn-secondary"
              data-bs-toggle="modal"
              data-bs-target="#ShowSetsModal"
            >
              Show Sets
            </button>
            <button
              id="addQuestionBtn"
              class="btn btn-sm btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#AddQuestionModal"
            >
              + Add New Question
            </button>
          </div>
        </div>

        <!-- Questions Table -->
        <table
          class="table table-striped mt-2"
          id="questionTable"
          style="margin-bottom: 120px"
        >
          <thead>
            <tr>
              <th>#</th>
              <th>Question</th>
              <th>Options</th>
              <th>Correct Answer</th>
              <th>Set</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Fixed Pagination Above Footer -->
        <div
          id="fixedPagination"
          class="fixed-pagination-above-footer bg-white border-top shadow-sm"
        >
          <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center py-2">
              <!-- Left side: Page size selector -->
              <div class="d-flex align-items-center">
                <label for="pageSize" class="form-label mb-0 me-2 text-nowrap"
                  >Show</label
                >
                <select id="pageSize" class="form-select form-select-sm w-auto">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
                <span class="ms-2 text-nowrap">entries per page</span>
              </div>

              <!-- Right side: Entry count and pagination buttons stacked -->
              <div class="d-flex flex-column align-items-end">
                <div id="entryCount" class="text-muted small mb-1"></div>
                <nav aria-label="Questions table pagination">
                  <ul
                    class="pagination pagination-sm mb-0"
                    id="pagination"
                  ></ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="app-footer">
        <div class="container text-center py-3">
          <small class="copyright">
            Designed with <i class="fas fa-heart" style="color: #fb866a"></i> by
            <a
              class="app-link"
              href="http://themes.3rdwavemedia.com"
              target="_blank"
              >Xiaoying Riley</a
            >
            for developers
          </small>
        </div>
      </footer>
    </div>

    <!-- Add Question Modal -->
    <div
      class="modal fade"
      id="AddQuestionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="AddQuestionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="AddQuestionModalLabel">
              Add Question
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addQuestionForm">
              <div class="mb-3">
                <label for="question" class="form-label">Question</label>
                <textarea
                  id="question"
                  name="question"
                  class="form-control fixed-height-textarea"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="options" class="form-label">Options</label>
                <textarea
                  id="options"
                  name="options"
                  class="form-control fixed-height-textarea"
                  placeholder="Enter options separated by commas"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="correctAnswer" class="form-label"
                  >Correct Answer</label
                >
                <input
                  type="text"
                  id="correctAnswer"
                  name="correctAnswer"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="setSelect" class="form-label">Set</label>
                <select id="setSelect" name="set" class="form-select" required>
                  <option value="" selected disabled>-- Select a Set --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              id="submitQuestionBtn"
              class="btn btn-primary"
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Question Modal -->
    <div
      class="modal fade"
      id="EditQuestionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="EditQuestionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="EditQuestionModalLabel">
              Edit Question
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editQuestionForm">
              <!-- Hidden field to store question ID -->
              <input type="hidden" id="editQuestionId" />

              <div class="mb-3">
                <label for="editQuestion" class="form-label">Question</label>
                <textarea
                  id="editQuestion"
                  name="question"
                  class="form-control fixed-height-textarea"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="editOptions" class="form-label">Options</label>
                <textarea
                  id="editOptions"
                  name="options"
                  class="form-control fixed-height-textarea"
                  placeholder="Enter options separated by commas"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="editCorrectAnswer" class="form-label"
                  >Correct Answer</label
                >
                <input
                  type="text"
                  id="editCorrectAnswer"
                  name="correctAnswer"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editSetSelect" class="form-label">Set</label>
                <select
                  id="editSetSelect"
                  name="set"
                  class="form-select"
                  required
                >
                  <option value="" disabled>-- Select a Set --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              id="updateQuestionBtn"
              class="btn btn-success"
            >
              Update Question
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Set Modal -->
    <div
      class="modal fade"
      id="AddSetModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="AddSetModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="AddSetModalLabel">Add New Set</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addSetForm">
              <div class="mb-3">
                <label for="newSetName" class="form-label">Set Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="newSetName"
                  name="newSetName"
                  placeholder="e.g. Set 1"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveSetBtn">
              Save Set
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Show Sets Modal -->
    <div
      class="modal fade"
      id="ShowSetsModal"
      tabindex="-1"
      aria-labelledby="ShowSetsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ShowSetsModalLabel">All Sets</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" style="max-height: 300px; overflow-y: auto">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Set Name</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="setsTableBody"></tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Set Modal -->
    <div
      class="modal fade"
      id="EditSetModal"
      tabindex="-1"
      aria-labelledby="EditSetModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="EditSetModalLabel">Edit Set</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editSetForm">
              <input type="hidden" id="editSetId" />
              <div class="mb-3">
                <label for="editSetName" class="form-label">Set Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editSetName"
                  name="editSetName"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="updateSetBtn">
              Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Javascript -->
    <script src="assets/plugins/popper.min.js"></script>
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/plugins/chart.js/chart.min.js"></script>
    <script src="assets/js/index-charts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Check session before initializing
        const sessionCheck = sessionManager.checkSession();
        if (!sessionCheck.valid) {
          sessionManager.redirectToLogin();
          return;
        }

        // ==== DOM Elements ====
        const saveSetBtn = document.getElementById("saveSetBtn");
        const newSetNameInput = document.getElementById("newSetName");
        const activeSetSelect = document.getElementById("activeSet");
        const showQuestionsSelect = document.getElementById("showQuestions");
        const setsTableBody = document.getElementById("setsTableBody");
        const editSetIdInput = document.getElementById("editSetId");
        const editSetNameInput = document.getElementById("editSetName");
        const updateSetBtn = document.getElementById("updateSetBtn");
        const showSetsModal = document.getElementById("ShowSetsModal");
        const editSetModal = document.getElementById("EditSetModal");
        const addQuestionModal = document.getElementById("AddQuestionModal");
        const editQuestionModal = document.getElementById("EditQuestionModal");
        const addQuestionForm = document.getElementById("addQuestionForm");
        const addQuestionSetSelect = document.getElementById("setSelect");
        const submitQuestionBtn = document.getElementById("submitQuestionBtn");
        const editQuestionForm = document.getElementById("editQuestionForm");
        const editQuestionIdInput = document.getElementById("editQuestionId");
        const editQuestionTextInput = document.getElementById("editQuestion");
        const editOptionsInput = document.getElementById("editOptions");
        const editCorrectAnswerInput =
          document.getElementById("editCorrectAnswer");
        const editQuestionSetSelect = document.getElementById("editSetSelect");
        const updateQuestionBtn = document.getElementById("updateQuestionBtn");
        const questionsTableBody = document.querySelector(
          "#questionTable tbody"
        );
        const pageSizeSelect = document.getElementById("pageSize");
        const pagination = document.getElementById("pagination");
        const entryCount = document.getElementById("entryCount");

        let setsCache = [];
        let setNamesArray = [];
        let allQuestions = [];
        let filteredQuestions = [];
        let currentPage = 1;
        let pageSize = 50;
        let selectedSetFilter = "";

        // ========== SESSIONSTORAGE CODE ==========
        const SHOW_QUESTIONS_KEY = "showQuestionsFilter";

        // Restore filter from sessionStorage if present
        if (sessionStorage.getItem(SHOW_QUESTIONS_KEY) !== null) {
          selectedSetFilter = sessionStorage.getItem(SHOW_QUESTIONS_KEY);
        }

        // ===== Utils =====
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        function safeJsonParse(text) {
          try {
            return JSON.parse(text);
          } catch (e) {
            console.error("JSON Parse Error:", e);
            console.error("Raw text:", text);
            return null;
          }
        }

        // Session-aware fetch
        async function sessionFetch(url, options = {}) {
          const sessionCheck = sessionManager.checkSession();
          if (!sessionCheck.valid) {
            sessionManager.redirectToLogin();
            throw new Error("Session invalid");
          }
          const defaultHeaders = {
            "Content-Type": "application/json",
            "X-Session-ID": sessionCheck.sessionData?.sessionId || "",
            "Cache-Control": "no-cache",
          };
          const fetchOptions = {
            ...options,
            headers: {
              ...defaultHeaders,
              ...options.headers,
            },
          };
          const response = await fetch(url, fetchOptions);
          if (response.status === 401 || response.status === 403) {
            Swal.fire({
              icon: "warning",
              title: "Session Expired",
              text: "Your session has expired. Please login again.",
              confirmButtonText: "OK",
            }).then(() => {
              sessionManager.logout();
            });
            throw new Error("Session expired");
          }
          sessionManager.updateLastActivity();
          return response;
        }

        function addBlurToShowSetsModal() {
          const showSetsModalContent =
            showSetsModal?.querySelector(".modal-content");
          if (showSetsModalContent)
            showSetsModalContent.classList.add("modal-blur");
        }

        function removeBlurFromShowSetsModal() {
          const showSetsModalContent =
            showSetsModal?.querySelector(".modal-content");
          if (showSetsModalContent)
            showSetsModalContent.classList.remove("modal-blur");
        }

        // ===== Options parsing & rendering =====
        function parseOptions(raw) {
          if (raw.includes("||")) {
            return raw
              .split("||")
              .map((opt) => opt.trim())
              .filter((opt) => opt.length > 0);
          } else {
            return raw
              .split(",")
              .map((opt) => opt.trim())
              .filter((opt) => opt.length > 0);
          }
        }

        function renderOptionsList(optionsArray) {
          return (
            "<ol style='padding-left:1.4em; margin-bottom:0;'>" +
            optionsArray
              .map(
                (opt) =>
                  `<li style="margin-bottom:2px;">${escapeHtml(opt)}</li>`
              )
              .join("") +
            "</ol>"
          );
        }

        // ===== FIXED Question count helpers =====
        function detectCountFromResponse(data, headers) {
          if (Array.isArray(data)) {
            return data.length;
          }
          if (headers) {
            const xTotal = headers.get("X-Total-Count");
            if (xTotal && !isNaN(parseInt(xTotal))) {
              return parseInt(xTotal);
            }
          }
          if (data && typeof data === "object") {
            const numericKeys = [
              "count",
              "total",
              "totalCount",
              "length",
              "size",
            ];
            for (const key of numericKeys) {
              if (typeof data[key] === "number") {
                return data[key];
              }
            }
            const arrayKeys = [
              "data",
              "questions",
              "results",
              "items",
              "list",
              "rows",
              "docs",
              "records",
            ];
            for (const key of arrayKeys) {
              if (Array.isArray(data[key])) {
                return data[key].length;
              }
            }
            if (data.meta && typeof data.meta === "object") {
              for (const key of numericKeys) {
                if (typeof data.meta[key] === "number") {
                  return data.meta[key];
                }
              }
            }
          }
          return 0;
        }

        async function getQuestionCountForSet(setId) {
          try {
            const response = await sessionFetch(
              `http://localhost:5000/api/questions/by-set/${encodeURIComponent(
                setId
              )}`,
              { method: "GET" }
            );
            if (!response.ok) {
              console.error(
                "❌ API response not OK:",
                response.status,
                response.statusText
              );
              return 0;
            }
            const rawText = await response.text();
            if (rawText.trim().startsWith("<")) {
              console.error(
                "❌ HTML received instead of JSON. Check server/CORS/auth."
              );
              console.error("Raw HTML:", rawText.substring(0, 200));
              return 0;
            }
            if (!rawText.trim()) {
              return 0;
            }
            const parsed = safeJsonParse(rawText);
            if (parsed === null) {
              console.error("❌ Failed to parse JSON response");
              return 0;
            }
            const count = detectCountFromResponse(parsed, response.headers);
            return count;
          } catch (err) {
            console.error("❌ Error counting questions:", err);
            return 0;
          }
        }

        function getQuestionCountFromCache(setId) {
          if (!Array.isArray(allQuestions) || allQuestions.length === 0) {
            return 0;
          }
          const count = allQuestions.filter((q) => {
            return q.set && (q.set._id === setId || q.set === setId);
          }).length;
          return count;
        }

        async function validateSetChangeForQuestion(
          questionId,
          fromSetId,
          toSetId
        ) {
          if (fromSetId === toSetId) {
            return { valid: true };
          }
          let fromSetCount = await getQuestionCountForSet(fromSetId);
          if (fromSetCount === 0) {
            fromSetCount = getQuestionCountFromCache(fromSetId);
          }
          const fromSet = setsCache.find((set) => set._id === fromSetId);
          const isFromSetActive = fromSet?.isActive || false;
          if (isFromSetActive && fromSetCount <= 5) {
            return {
              valid: false,
              reason: "active_set_insufficient",
              fromSetName: fromSet?.name || "Unknown Set",
              fromSetCount: fromSetCount,
            };
          }
          return { valid: true };
        }

        async function activateSet(setId) {
          try {
            const response = await sessionFetch(
              `http://localhost:5000/api/sets/${encodeURIComponent(
                setId
              )}/activate`,
              { method: "PUT" }
            );
            if (!response.ok) throw new Error("Failed to activate set");
            await response.json().catch(() => null);
            Swal.fire({
              icon: "success",
              title: "Success",
              text: "Set activated successfully!",
              timer: 1500,
              showConfirmButton: false,
            });
            return true;
          } catch (error) {
            console.error("Error activating set:", error);
            if (
              error.message !== "Session expired" &&
              error.message !== "Session invalid"
            ) {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to activate set",
              });
            }
            return false;
          }
        }

        async function deactivateAllSets() {
          try {
            const response = await sessionFetch(
              "http://localhost:5000/api/sets/deactivate",
              {
                method: "PUT",
              }
            );
            if (!response.ok) throw new Error("Failed to deactivate sets");
            return true;
          } catch (error) {
            console.error("Error deactivating sets:", error);
            return false;
          }
        }

        if (activeSetSelect) {
          activeSetSelect.addEventListener("change", async function () {
            sessionManager.updateLastActivity();
            const selectedSetId = this.value;
            if (!selectedSetId) {
              const success = await deactivateAllSets();
              if (success) {
                Swal.fire({
                  icon: "info",
                  title: "No Active Set",
                  text: "All sets have been deactivated",
                  timer: 1500,
                  showConfirmButton: false,
                });
                await loadSets();
                await loadQuestions();
              }
              return;
            }
            let questionCount = await getQuestionCountForSet(selectedSetId);
            if (questionCount === 0) {
              questionCount = getQuestionCountFromCache(selectedSetId);
            }
            if (questionCount <= 5) {
              Swal.fire({
                icon: "warning",
                title: "Cannot Activate Set",
                html: `
                  <p>This set doesn't have enough questions.</p>
                  <p><strong>Current questions: ${questionCount}</strong></p>
                  <p>A set must have <strong>more than 5 questions</strong> to be activated.</p>
                  <p>Please add more questions to this set.</p>
                `,
                confirmButtonText: "OK",
              });
              const currentActiveSet = setsCache.find((set) => set.isActive);
              this.value = currentActiveSet ? currentActiveSet._id : "";
              return;
            }
            const success = await activateSet(selectedSetId);
            if (success) {
              setsCache.forEach((set) => {
                set.isActive = set._id === selectedSetId;
              });
              await loadSets();
              await loadQuestions();
            } else {
              const currentActiveSet = setsCache.find((set) => set.isActive);
              this.value = currentActiveSet ? currentActiveSet._id : "";
            }
          });
        }

        // UPDATED: filterQuestions function to save state
        function filterQuestions() {
          sessionManager.updateLastActivity();
          if (!selectedSetFilter || selectedSetFilter === "") {
            filteredQuestions = [...allQuestions];
          } else {
            filteredQuestions = allQuestions.filter(
              (q) => q.set && q.set._id === selectedSetFilter
            );
          }
          currentPage = 1;
          renderTable();
          renderPagination();
          updateEntryCount();
        }

        // ========== Show Questions select persistence ==========
        if (showQuestionsSelect) {
          // Restore saved value if present
          if (sessionStorage.getItem(SHOW_QUESTIONS_KEY) !== null) {
            showQuestionsSelect.value =
              sessionStorage.getItem(SHOW_QUESTIONS_KEY);
          }

          // On change, save new value in sessionStorage
          showQuestionsSelect.addEventListener("change", () => {
            sessionManager.updateLastActivity();
            selectedSetFilter = showQuestionsSelect.value;
            sessionStorage.setItem(SHOW_QUESTIONS_KEY, selectedSetFilter); // SAVE
            filterQuestions();
          });
        }

        function renderPagination() {
          if (!pagination) return;
          pagination.innerHTML = "";
          const pageCount = Math.ceil(filteredQuestions.length / pageSize) || 1;

          const prevLi = document.createElement("li");
          prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
          prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">&laquo;</a>`;
          if (currentPage > 1) {
            prevLi.addEventListener("click", (e) => {
              e.preventDefault();
              sessionManager.updateLastActivity();
              currentPage--;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
          }
          pagination.appendChild(prevLi);

          for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${i === currentPage ? "active" : ""}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
              e.preventDefault();
              sessionManager.updateLastActivity();
              currentPage = i;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
            pagination.appendChild(li);
          }

          const nextLi = document.createElement("li");
          nextLi.className = `page-item ${
            currentPage === pageCount ? "disabled" : ""
          }`;
          nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">&raquo;</a>`;
          if (currentPage < pageCount) {
            nextLi.addEventListener("click", (e) => {
              e.preventDefault();
              sessionManager.updateLastActivity();
              currentPage++;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
          }
          pagination.appendChild(nextLi);
        }

        function updateEntryCount() {
          if (!entryCount) return;
          if (filteredQuestions.length === 0) {
            entryCount.textContent = "Showing 0 entries";
            return;
          }
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(
            currentPage * pageSize,
            filteredQuestions.length
          );
          entryCount.textContent = `Showing ${start} to ${end} of ${filteredQuestions.length} entries`;
        }

        function renderTable() {
          if (!questionsTableBody) return;

          questionsTableBody.innerHTML = "";

          if (filteredQuestions.length === 0) {
            const noDataMessage =
              selectedSetFilter === "active"
                ? "No questions found in active sets."
                : selectedSetFilter
                ? `No questions found for the selected set.`
                : "No questions available.";
            questionsTableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-5">
            <div class="d-flex flex-column align-items-center">
              <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
              <h5 class="text-muted mb-2">No Records Found</h5>
              <p class="text-muted mb-0">
                ${noDataMessage}
                <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#AddQuestionModal">
                  Add your first question
                </a> 
                to get started!
              </p>
            </div>
          </td>
        </tr>`;
            return;
          }

          const startIndex = (currentPage - 1) * pageSize;
          const endIndex = startIndex + pageSize;
          const pageQuestions = filteredQuestions.slice(startIndex, endIndex);

          pageQuestions.forEach((q, idx) => {
            let setDisplay = "Unknown Set";
            let setBadgeClass = "bg-secondary";
            if (q.set) {
              setDisplay = q.set.name || "Unknown Set";
              setBadgeClass = q.set.isActive
                ? "active-set-badge"
                : "bg-primary";
              if (q.set.isActive) setDisplay += " ★";
            }

            const optionsArray = Array.isArray(q.options) ? q.options : [];
            const optionsHtml = renderOptionsList(optionsArray);

            const globalIndex = startIndex + idx + 1;
            const escapedQuestion = escapeHtml(q.question || "");
            const escapedCorrectAnswer = escapeHtml(q.correctAnswer || "");

            questionsTableBody.innerHTML += `
        <tr>
          <td>${globalIndex}</td>
          <td class="text-wrap" style="max-width: 300px;">${escapedQuestion}</td>
          <td class="text-wrap" style="max-width: 250px; font-size: 0.9em;">${optionsHtml}</td>
          <td><strong class="text-success">${escapedCorrectAnswer}</strong></td>
          <td><span class="badge ${setBadgeClass}">${setDisplay}</span></td>
          <td>
            <a href="javascript:void(0);" class="px-2 text-primary edit-question" data-id="${q._id}" title="Edit Question">
              <i class="fas fa-edit"></i>
            </a>
            <a href="javascript:void(0);" class="px-2 text-danger delete-question" data-id="${q._id}" data-question="${q.question}" title="Delete Question">
              <i class="fas fa-trash-alt"></i>
            </a>
          </td>
        </tr>`;
          });

          document.querySelectorAll(".edit-question").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              sessionManager.updateLastActivity();
              const id = e.currentTarget.dataset.id;
              editQuestion(id);
            });
          });

          document.querySelectorAll(".delete-question").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              sessionManager.updateLastActivity();
              const id = e.currentTarget.dataset.id;
              const question = e.currentTarget.dataset.question;
              deleteQuestion(id, question);
            });
          });
        }

        // UPDATED: loadSets restores Show Questions select from session
        async function loadSets() {
          try {
            const res = await sessionFetch("http://localhost:5000/api/sets");
            if (!res.ok) throw new Error("Failed to fetch sets");
            let sets = await res.json();
            sets = sets.reverse();
            setsCache = sets;
            setNamesArray = sets.map((set) => set.name);

            if (activeSetSelect) {
              activeSetSelect.innerHTML =
                '<option value="">Select Set</option>';
              sets.forEach((set) => {
                const opt = document.createElement("option");
                opt.value = set._id;
                opt.textContent = set.name;
                if (set.isActive) opt.selected = true;
                activeSetSelect.appendChild(opt);
              });
            }

            if (showQuestionsSelect) {
              showQuestionsSelect.innerHTML = `<option value="" selected>All</option>`;
              sets.forEach((set) => {
                const opt = document.createElement("option");
                opt.value = set._id;
                opt.textContent = set.name;
                showQuestionsSelect.appendChild(opt);
              });

              // Restore from sessionStorage if present
              if (sessionStorage.getItem(SHOW_QUESTIONS_KEY) !== null) {
                showQuestionsSelect.value =
                  sessionStorage.getItem(SHOW_QUESTIONS_KEY);
                selectedSetFilter = sessionStorage.getItem(SHOW_QUESTIONS_KEY);
              }
            }

            if (addQuestionSetSelect) {
              addQuestionSetSelect.innerHTML =
                '<option value="" selected disabled>-- Select a Set --</option>';
              sets.forEach((set) => {
                const opt = document.createElement("option");
                opt.value = set._id;
                opt.textContent = set.name;
                addQuestionSetSelect.appendChild(opt);
              });
            }

            if (editQuestionSetSelect) {
              editQuestionSetSelect.innerHTML =
                '<option value="" disabled>-- Select a Set --</option>';
              sets.forEach((set) => {
                const opt = document.createElement("option");
                opt.value = set._id;
                opt.textContent = set.name;
                editQuestionSetSelect.appendChild(opt);
              });
            }

            if (setsTableBody) {
              setsTableBody.innerHTML = "";
              sets.forEach((set, index) => {
                const activeIndicator = set.isActive
                  ? '<span class="badge active-set-badge ms-2">Active ★</span>'
                  : "";
                setsTableBody.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${set.name}${activeIndicator}</td>
              <td>
                <a href="javascript:void(0);" class="px-2 edit-set" data-id="${
                  set._id
                }" data-name="${set.name}" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="javascript:void(0);" class="px-2 delete-set" data-id="${
                  set._id
                }" data-name="${set.name}" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </a>
              </td>
            </tr>`;
              });

              document.querySelectorAll(".edit-set").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  sessionManager.updateLastActivity();
                  const id = e.currentTarget.dataset.id;
                  const name = e.currentTarget.dataset.name;
                  editSetIdInput.value = id;
                  editSetNameInput.value = name;
                  addBlurToShowSetsModal();
                  new bootstrap.Modal(editSetModal).show();
                });
              });

              document.querySelectorAll(".delete-set").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  sessionManager.updateLastActivity();
                  const id = e.currentTarget.dataset.id;
                  const name = e.currentTarget.dataset.name;
                  deleteSet(id, name);
                });
              });
            }
          } catch (err) {
            console.error("Error fetching sets:", err);
          }
        }

        // ... rest of your code (no changes needed) ...

        async function loadQuestions() {
          if (!questionsTableBody) {
            console.error(
              "Questions table body not found! Make sure #questionTable exists."
            );
            return;
          }
          try {
            const res = await sessionFetch(
              "http://localhost:5000/api/questions"
            );
            if (!res.ok) throw new Error("Failed to fetch questions");
            const questions = await res.json();
            questions.sort(
              (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
            );
            allQuestions = questions;
            filterQuestions();
          } catch (err) {
            console.error("Error fetching questions:", err);
            if (questionsTableBody) {
              questionsTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <div class="d-flex flex-column align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <h6 class="text-danger mb-1">Error Loading Questions</h6>
                <small class="text-muted">${err.message}</small>
              </div>
            </td>
          </tr>`;
            }
            if (pagination) pagination.innerHTML = "";
            if (entryCount) entryCount.textContent = "";
          }
        }

        // ... (the rest of your CRUD and UI logic does not change) ...

        (async () => {
          await loadSets();
          await loadQuestions();
        })();
      });

      document.addEventListener("DOMContentLoaded", function () {
        const logoutBtn = document.getElementById("logout");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            handleLogout();
          });
        }
      });

      function handleLogout() {
        Swal.fire({
          title: "Confirm Logout",
          text: "Are you sure you want to logout?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, logout",
          cancelButtonText: "Cancel",
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              title: "Logging out...",
              text: "Please wait",
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });
            setTimeout(() => {
              sessionManager.logout();
            }, 1000);
          }
        });
      }
    </script>
  </body>
</html>
