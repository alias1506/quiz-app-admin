<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Portal - Bootstrap 5 Admin Dashboard Template For Developers</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta
      name="description"
      content="Portal - Bootstrap 5 Admin Dashboard Template For Developers"
    />
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media" />
    <link rel="shortcut icon" href="favicon.ico" />

    <!-- FontAwesome JS-->
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

    <!-- ✅ Fixed Pagination Styles -->
    <style>
      .fixed-pagination-above-footer {
        position: fixed;
        bottom: 50px; /* Adjust to match your footer height */
        left: 0;
        right: 0;
        z-index: 1020;
        background: white;
        border-top: 1px solid #dee2e6;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .pagination-spacer-above-footer {
        height: 120px; /* Footer height (60px) + Pagination height (60px) */
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .fixed-pagination-above-footer .d-flex {
          flex-direction: column;
          gap: 8px;
          padding: 8px 0;
        }

        .fixed-pagination-above-footer {
          bottom: 60px;
        }

        .pagination-spacer-above-footer {
          height: 140px;
        }
      }
    </style>
    <script src="assets/js/sessionManager.js"></script>
    <script>
      (function () {
        const session = localStorage.getItem("userSession");
        if (!session) {
          window.location.href = "index.html";
          return;
        }

        try {
          const sessionData = JSON.parse(session);
          if (!sessionData.isAuthenticated) {
            window.location.href = "index.html";
            return;
          }

          // Check if session has expired
          const currentTime = new Date().getTime();
          const sessionAge = currentTime - sessionData.loginTime;
          const maxAge = 24 * 60 * 60 * 1000; // 24 hours

          if (sessionAge > maxAge) {
            localStorage.removeItem("userSession");
            window.location.href = "index.html";
            return;
          }
        } catch (error) {
          localStorage.removeItem("userSession");
          window.location.href = "index.html";
          return;
        }
      })();
    </script>
  </head>

  <body class="app">
    <header class="app-header fixed-top">
      <div class="app-header-inner">
        <div class="container-fluid py-2">
          <div class="app-header-content">
            <div class="row justify-content-between align-items-center">
              <div class="col-auto">
                <a
                  id="sidepanel-toggler"
                  class="sidepanel-toggler d-inline-block d-xl-none"
                  href="#"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="30"
                    height="30"
                    viewBox="0 0 30 30"
                    role="img"
                  >
                    <title>Menu</title>
                    <path
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-miterlimit="10"
                      stroke-width="2"
                      d="M4 7h22M4 15h22M4 23h22"
                    ></path>
                  </svg>
                </a>
              </div>

              <div class="search-mobile-trigger d-sm-none col">
                <i
                  class="search-mobile-trigger-icon fa-solid fa-magnifying-glass"
                ></i>
              </div>

              <div class="app-search-box col">
                <form class="app-search-form">
                  <input
                    type="text"
                    placeholder="Search..."
                    name="search"
                    class="form-control search-input"
                  />
                  <button
                    type="submit"
                    class="btn search-btn btn-primary"
                    value="Search"
                  >
                    <i class="fa-solid fa-magnifying-glass"></i>
                  </button>
                </form>
              </div>

              <div class="app-utilities col-auto">
                <div class="app-utility-item app-user-dropdown dropdown">
                  <a
                    class="dropdown-toggle"
                    id="user-dropdown-toggle"
                    data-bs-toggle="dropdown"
                    href="#"
                    role="button"
                    aria-expanded="false"
                  >
                    <img src="assets/images/user.png" alt="user profile" />
                  </a>
                  <ul
                    class="dropdown-menu"
                    aria-labelledby="user-dropdown-toggle"
                  >
                    <li>
                      <a
                        class="dropdown-item"
                        href="javascript:void(0);"
                        id="logout"
                        >Log Out</a
                      >
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!--//row-->
          </div>
          <!--//app-header-content-->
        </div>
      </div>

      <div id="app-sidepanel" class="app-sidepanel">
        <div id="sidepanel-drop" class="sidepanel-drop"></div>
        <div class="sidepanel-inner d-flex flex-column">
          <a href="#" id="sidepanel-close" class="sidepanel-close d-xl-none"
            >&times;</a
          >
          <div class="app-branding">
            <a class="app-logo" href="dashboard.html">
              <img
                class="logo-icon me-2"
                src="assets/images/app-logo.svg"
                alt="logo"
              />
              <span class="logo-text">PORTAL</span>
            </a>
          </div>

          <nav id="app-nav-main" class="app-nav app-nav-main flex-grow-1">
            <ul class="app-menu list-unstyled accordion" id="menu-accordion">
              <li class="nav-item">
                <a class="nav-link active" href="dashboard.html">
                  <span class="nav-link-text">Dashboard</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="allQuestions.html">
                  <span class="nav-link-text">Add Questions</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <div class="app-wrapper">
      <div class="px-5 py-3">
        <h1>Users</h1>

        <table class="table table-striped mb-0" id="userTable">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Joined On</th>
              <th scope="col">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Spacer to prevent content from hiding behind fixed pagination -->
        <div class="pagination-spacer-above-footer"></div>
      </div>

      <!-- ✅ Fixed Pagination Above Footer -->
      <div
        id="fixedPagination"
        class="fixed-pagination-above-footer bg-white border-top shadow-sm"
      >
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center py-2">
            <!-- Left side: Page size selector -->
            <div class="d-flex align-items-center">
              <label for="pageSize" class="form-label mb-0 me-2 text-nowrap"
                >Show</label
              >
              <select id="pageSize" class="form-select form-select-sm w-auto">
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="150">150</option>
                <option value="200">200</option>
              </select>
              <span class="ms-2 text-nowrap">entries per page</span>
            </div>

            <!-- ✅ Right side: Entry count and pagination buttons stacked -->
            <div class="d-flex flex-column align-items-end">
              <div id="entryCount" class="text-muted small mb-1"></div>
              <nav aria-label="User table pagination">
                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer class="app-footer">
        <div class="container text-center py-3">
          <small class="copyright">
            Designed with <span class="sr-only">love</span>
            <i class="fas fa-heart" style="color: #fb866a"></i> by
            <a
              class="app-link"
              href="http://themes.3rdwavemedia.com"
              target="_blank"
              >Xiaoying Riley</a
            >
            for developers
          </small>
        </div>
      </footer>
    </div>

    <!-- Javascript -->
    <script src="assets/plugins/popper.min.js"></script>
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/plugins/chart.js/chart.min.js"></script>
    <script src="assets/js/index-charts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tableBody = document.querySelector("#userTable tbody");
        const pageSizeSelect = document.getElementById("pageSize");
        const entryCount = document.getElementById("entryCount");
        const pagination = document.getElementById("pagination");

        let users = [];
        let currentPage = 1;
        let pageSize = parseInt(pageSizeSelect.value);

        // ✅ Format date to dd/mm/yyyy
        function formatDate(dateString) {
          if (!dateString) return "N/A";

          try {
            const date = new Date(dateString);

            // Check if date is valid
            if (isNaN(date.getTime())) return "N/A";

            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-based
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
          } catch (error) {
            console.error("Error formatting date:", error);
            return "N/A";
          }
        }

        async function fetchUsers() {
          try {
            const res = await fetch("http://localhost:5000/api/users");
            users = await res.json();

            // ✅ Sort users: oldest first (latest last)
            users.sort((a, b) => {
              const dateA = new Date(a.joinedOn || a.createdAt || 0);
              const dateB = new Date(b.joinedOn || b.createdAt || 0);
              return dateA - dateB; // Ascending order (oldest first)
            });

            renderTable();
            renderPagination();
            updateEntryCount();
          } catch (err) {
            console.error("Error fetching users:", err);
            tableBody.innerHTML =
              '<tr><td colspan="5" class="text-danger text-center">Failed to load users.</td></tr>';
          }
        }

        function renderTable() {
          tableBody.innerHTML = "";
          if (users.length === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="5" class="text-center text-muted">No records found</td></tr>';
            return;
          }

          const start = (currentPage - 1) * pageSize;
          const paginatedUsers = users.slice(start, start + pageSize);

          paginatedUsers.forEach((user, index) => {
            // ✅ Use the formatDate function for consistent dd/mm/yyyy format
            const joinedDate = formatDate(user.joinedOn || user.createdAt);

            tableBody.innerHTML += `
              <tr>
                <th scope="row">${start + index + 1}</th>
                <td>${user.name || "N/A"}</td>
                <td>${user.email || "N/A"}</td>
                <td>${joinedDate}</td>
                <td>
                  <button class="btn btn-sm btn-danger" onclick="deleteUser('${
                    user._id
                  }')">Delete</button>
                </td>
              </tr>
            `;
          });
        }

        function renderPagination() {
          pagination.innerHTML = "";
          const pageCount = Math.ceil(users.length / pageSize) || 1;

          // Previous button
          const prevLi = document.createElement("li");
          prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
          prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">&laquo;</a>`;
          if (currentPage > 1) {
            prevLi.addEventListener("click", (e) => {
              e.preventDefault();
              currentPage--;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
          }
          pagination.appendChild(prevLi);

          // Page numbers
          for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${i === currentPage ? "active" : ""}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
              e.preventDefault();
              currentPage = i;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
            pagination.appendChild(li);
          }

          // Next button
          const nextLi = document.createElement("li");
          nextLi.className = `page-item ${
            currentPage === pageCount ? "disabled" : ""
          }`;
          nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">&raquo;</a>`;
          if (currentPage < pageCount) {
            nextLi.addEventListener("click", (e) => {
              e.preventDefault();
              currentPage++;
              renderTable();
              renderPagination();
              updateEntryCount();
            });
          }
          pagination.appendChild(nextLi);
        }

        function updateEntryCount() {
          if (users.length === 0) {
            entryCount.textContent = "Showing 0 entries";
            return;
          }

          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(currentPage * pageSize, users.length);
          entryCount.textContent = `Showing ${start} to ${end} of ${users.length} entries`;
        }

        pageSizeSelect.addEventListener("change", () => {
          pageSize = parseInt(pageSizeSelect.value);
          currentPage = 1;
          renderTable();
          renderPagination();
          updateEntryCount();
        });

        window.deleteUser = async function (id) {
          const result = await Swal.fire({
            title: "Are you sure?",
            text: "This user will be permanently deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!",
          });

          if (result.isConfirmed) {
            try {
              const res = await fetch(`http://localhost:5000/api/users/${id}`, {
                method: "DELETE",
              });
              const data = await res.json();

              if (res.ok) {
                Swal.fire(
                  "Deleted!",
                  data.message || "User deleted.",
                  "success"
                );
                users = users.filter((u) => u._id !== id);
                renderTable();
                renderPagination();
                updateEntryCount();
              } else {
                Swal.fire(
                  "Error",
                  data.message || "Failed to delete user.",
                  "error"
                );
              }
            } catch (err) {
              console.error("Delete failed", err);
              Swal.fire("Error", "Server error", "error");
            }
          }
        };

        fetchUsers();
      });

      // logout
      document.addEventListener("DOMContentLoaded", function () {
        const logoutBtn = document.getElementById("logout");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            handleLogout();
          });
        }
      });

      function handleLogout() {
        Swal.fire({
          title: "Confirm Logout",
          text: "Are you sure you want to logout?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, logout",
          cancelButtonText: "Cancel",
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading state
            Swal.fire({
              title: "Logging out...",
              text: "Please wait",
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            // Clear session and redirect after short delay
            setTimeout(() => {
              sessionManager.logout();
            }, 1000);
          }
        });
      }
    </script>
  </body>
</html>
